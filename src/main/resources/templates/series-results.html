<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–µ—Ä–∏–π –∏–≥—Ä –≤ –º–∞—Ñ–∏—é</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1500px;
            margin: 0 auto;
        }
        h1, h2, h3 {
            color: #333;
        }
        .tournaments-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }
        .tournament-section {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            position: relative;
        }
        @media (max-width: 1000px) {
            .tournament-section {
                flex: 1 1 100%;
                max-width: none;
            }
        }
        select, button {
            padding: 8px 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f4f4f4;
        }
        .results-container {
            margin-top: 20px;
            position: relative;
        }
        .tournament-header {
            margin-bottom: 15px;
        }
        .series-selector {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .series-selector label {
            margin-right: 10px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading-indicator {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 10;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞–º–∏ */
        .tournament-management {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        .tournament-link {
            margin-bottom: 20px;
            text-align: center;
        }

        .tournament-link a {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
        }

        .tournament-link a:hover {
            background-color: #0056b3;
        }

        .add-tournament-form {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .tournament-list {
            margin-top: 20px;
        }

        .tournament-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .tournament-info {
            flex-grow: 1;
        }

        .tournament-name {
            font-weight: bold;
            color: #333;
        }

        .tournament-details {
            font-size: 0.9em;
            color: #666;
        }

        .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .remove-btn:hover {
            background-color: #c82333;
        }

        .success-message, .error-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ–π —Å–µ–∫—Ü–∏–∏ */
        .tournament-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tournament-management-header:hover {
            background-color: #f0f0f0;
            margin: 0 -20px;
            padding: 10px 20px;
            border-radius: 5px;
        }

        .collapse-toggle {
            font-size: 1.2em;
            font-weight: bold;
            color: #4CAF50;
            transition: transform 0.3s ease;
        }

        .collapse-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .tournament-management-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }

        .tournament-management-content.collapsed {
            max-height: 0;
            opacity: 0;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–µ—Ä–∏–π –∏–≥—Ä –≤ –º–∞—Ñ–∏—é</h1>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞–º–∏ -->
    <div class="tournament-management">
        <div class="tournament-management-header" onclick="toggleTournamentManagement()">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞–º–∏</h2>
            <span class="collapse-toggle collapsed" id="collapseToggle">‚ñº</span>
        </div>

        <div class="tournament-management-content" id="tournamentManagementContent">
            <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç—É—Ä–Ω–∏—Ä–æ–≤ -->
            <div class="tournament-link">
                <a href="https://mafoverlay.online/admin/photos/tournaments" target="_blank">
                    üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤ –Ω–∞ MafOverlay
                </a>
            </div>

            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞ -->
            <div class="add-tournament-form">
                <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä</h3>
                <form id="addTournamentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tournamentId">ID —Ç—É—Ä–Ω–∏—Ä–∞:</label>
                            <input id="tournamentId" min="1" name="tournamentId" required type="number">
                        </div>
                        <div class="form-group">
                            <label for="tournamentName">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                            <input id="tournamentName" name="tournamentName" required type="text">
                        </div>
                        <div class="form-group">
                            <label for="gamesPerSeries">–ò–≥—Ä –≤ —Å–µ—Ä–∏–∏:</label>
                            <input id="gamesPerSeries" min="1" name="gamesPerSeries" required type="number" value="4">
                        </div>
                        <div class="form-group">
                            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä</button>
                        </div>
                    </div>
                </form>

                <div class="success-message" id="successMessage"></div>
                <div class="error-message" id="errorMessage"></div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤ -->
            <div class="tournament-list">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä—ã</h3>
                <div id="activeTournamentsList">
                    <div class="tournament-item" th:each="tournament : ${activeTournaments}">
                        <div class="tournament-info">
                            <div class="tournament-name" th:text="${tournament.name}"></div>
                            <div class="tournament-details">
                                ID: <span th:text="${tournament.id}"></span> |
                                –ò–≥—Ä –≤ —Å–µ—Ä–∏–∏: <span th:text="${tournament.gamesPerSeries}"></span>
                            </div>
                        </div>
                        <button class="remove-btn" th:onclick="'removeTournament(' + ${tournament.id} + ')'">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tournaments-container">
        <div class="tournament-section" th:each="tournamentData : ${tournamentsData}">
            <div class="tournament-header">
                <h2 th:text="${tournamentData.competition.name}"></h2>
                <div class="series-selector">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–∏—é:</label>
                    <select class="series-select" th:data-competition-id="${tournamentData.competition.id}">
                        <option th:each="seriesNumber : ${tournamentData.seriesNumbers}"
                                th:selected="${seriesNumber == tournamentData.currentSeries}"
                                th:text="${'–°–µ—Ä–∏—è ' + seriesNumber}"
                                th:value="${seriesNumber}"></option>
                    </select>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="loading-indicator" th:id="'loading-' + ${tournamentData.competition.id}">
                <div class="spinner"></div>
            </div>

            <div class="results-container" th:id="'results-' + ${tournamentData.competition.id}">
                <h3 th:text="'–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–µ—Ä–∏–∏ ' + ${tournamentData.currentSeries}"></h3>
                <table>
                    <thead>
                    <tr>
                        <th>–ò–≥—Ä–æ–∫</th>
                        <th>–ë–∞–ª–ª—ã</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="player : ${tournamentData.playerPoints}">
                        <td th:text="${player.first}"></td>
                        <td th:text="${player.second}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const seriesSelects = document.querySelectorAll('.series-select');

        seriesSelects.forEach(select => {
            select.addEventListener('change', function () {
                const competitionId = this.getAttribute('data-competition-id');
                const seriesNumber = this.value;
                const resultsContainer = document.getElementById(`results-${competitionId}`);
                const loadingIndicator = document.getElementById(`loading-${competitionId}`);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                loadingIndicator.style.display = 'flex';

                fetch(`/clubs/polemicaspb/leagues/competition/${competitionId}/series/${seriesNumber}`)
                    .then(response => response.json())
                    .then(data => {
                        let html = `<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–µ—Ä–∏–∏ ${seriesNumber}</h3>
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>–ò–≥—Ä–æ–∫</th>
                                                    <th>–ë–∞–ª–ª—ã</th>
                                                </tr>
                                            </thead>
                                            <tbody>`;

                        data.forEach(player => {
                            let points = player.second;

                            html += `<tr>
                                            <td>${player.first}</td>
                                            <td>${points}</td>
                                         </tr>`;
                        });

                        html += `</tbody></table>`;
                        resultsContainer.innerHTML = html;

                        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                        loadingIndicator.style.display = 'none';
                    })
                    .catch(error => {
                        console.error('Error loading data:', error);
                        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                        loadingIndicator.style.display = 'none';
                    });
            });
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞–º–∏
        const addTournamentForm = document.getElementById('addTournamentForm');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞
        addTournamentForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const tournamentData = {
                id: parseInt(formData.get('tournamentId')),
                name: formData.get('tournamentName'),
                gamesPerSeries: parseInt(formData.get('gamesPerSeries'))
            };

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
            if (!tournamentData.id || tournamentData.id <= 0) {
                showError('ID —Ç—É—Ä–Ω–∏—Ä–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º');
                return;
            }
            if (!tournamentData.name || tournamentData.name.trim() === '') {
                showError('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }
            if (!tournamentData.gamesPerSeries || tournamentData.gamesPerSeries <= 0) {
                showError('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä –≤ —Å–µ—Ä–∏–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
                return;
            }

            try {
                const response = await fetch('/clubs/polemicaspb/leagues/add-tournament', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(tournamentData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess(`–¢—É—Ä–Ω–∏—Ä "${result.name}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!`);
                    addTournamentForm.reset();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showError(errorData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—É—Ä–Ω–∏—Ä–∞');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—É—Ä–Ω–∏—Ä–∞');
            }
        });

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞
    async function removeTournament(tournamentId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç—É—Ä–Ω–∏—Ä?')) {
            return;
        }

        try {
            const response = await fetch(`/clubs/polemicaspb/leagues/remove-tournament/${tournamentId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const result = await response.json();
                alert(result.message || '–¢—É—Ä–Ω–∏—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
                location.reload();
            } else {
                const errorData = await response.json().catch(() => ({}));
                alert(errorData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—É—Ä–Ω–∏—Ä–∞');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—É—Ä–Ω–∏—Ä–∞');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Å–µ–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞–º–∏
    function toggleTournamentManagement() {
        const content = document.getElementById('tournamentManagementContent');
        const toggle = document.getElementById('collapseToggle');

        if (content.classList.contains('collapsed')) {
            // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
            content.classList.remove('collapsed');
            content.style.maxHeight = content.scrollHeight + 'px';
            toggle.textContent = '‚ñº';
            toggle.classList.remove('collapsed');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage
            localStorage.setItem('tournamentManagementCollapsed', 'false');
        } else {
            // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
            content.style.maxHeight = content.scrollHeight + 'px';
            content.offsetHeight; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π reflow
            content.style.maxHeight = '0';
            content.classList.add('collapsed');
            toggle.textContent = '‚ñ∂';
            toggle.classList.add('collapsed');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage
            localStorage.setItem('tournamentManagementCollapsed', 'true');
        }
    }

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function () {
        const isCollapsed = localStorage.getItem('tournamentManagementCollapsed') === 'true';
        const content = document.getElementById('tournamentManagementContent');
        const toggle = document.getElementById('collapseToggle');

        if (isCollapsed) {
            content.classList.add('collapsed');
            content.style.maxHeight = '0';
            toggle.textContent = '‚ñ∂';
            toggle.classList.add('collapsed');
        } else {
            content.style.maxHeight = content.scrollHeight + 'px';
        }
    });
</script>
</body>
</html>
